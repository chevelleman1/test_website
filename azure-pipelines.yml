trigger:
  - main
  - master

variables:
   DOCKER_BUILDKIT: 1
   siteRepDir: '$(Build.SourcesDirectory)/app'
   testRepDir: '$(Build.SourcesDirectory)/tests'
  
  
resources:
  repositories:
    - repository: automatedtesting
      type: github
      endpoint: 'chevelleman1'
      name: 'chevelleman1/automatedtesting'

    - repository: test_website
      type: github
      endpoint: 'chevelleman1'
      name: 'chevelleman1/test_website'

pool:
  name: 'linuxBuildBox'

steps:

- checkout: automatedtesting 
  path: s/tests

- checkout: test_website 
  path: 's/app'

- task: NodeTool@0
  inputs:
    versionSpec: '18.x'
  displayName: 'Install Node.js'
      

- script:  |
    # Disable telemetry and audit to prevent the "Exit handler" hang
    npm install --no-audit --no-fund --no-update-notifier
    echo "XXXXXXXXXXXXXX- $(Build.SourcesDirectory)"

  workingDirectory: 'app/node-js-dummy-test-master'
  displayName: 'Build (Install dependencies)'

- script: |
    echo "Starting local website..."
    # Start server and detach from STDIO to prevent pipeline hang
    nohup npm start > /dev/null 2>&1 & 
    
    # Save PID to the workspace root so it's easy for other steps to find
    echo $! > $(Pipeline.Workspace)/server.pid
    echo "Server started with PID $(cat $(Pipeline.Workspace)/server.pid)"
    
    # Wait for the site to be up
    echo "Waiting for server on port 3000..."
    # Attempt to connect to localhost:3000 once per second, up to 60 times
    for i in {1..60}; do
      if curl -s localhost:3000 > /dev/null; then
        echo "Server is UP and responding!"
        exit 0
      fi
      echo "Server not ready yet... waiting (attempt $i)"
      sleep 1
    done

    echo "Error: Server failed to start within 60 seconds."
    cat server.log # Print logs so you can see why it failed
    exit 1
  workingDirectory: 'app/node-js-dummy-test-master'
  displayName: 'Start Server'

- script: |
    echo "Installing Playwright/Test dependencies..."
    npm install
    # Uncomment if browsers aren't on your agent yet:
    #npx playwright install --with-deps
    
    echo "Running UI Automated Tests..."
    npm test
  workingDirectory: tests
  displayName: 'Run UI Automated Tests'

- script: |
    if [ -f $(Pipeline.Workspace)/server.pid ]; then
      PID=$(cat $(Pipeline.Workspace)/server.pid)
      echo "Stopping server with PID $PID..."
      kill $PID || true
      rm $(Pipeline.Workspace)/server.pid
    fi
    # Extra safety: kill anything on port 3000
    fuser -k 3000/tcp || true
  workingDirectory: 'app/node-js-dummy-test-master'
  displayName: 'Stop Server'
  condition: always()


- task: Docker@2
  displayName: 'Build and push an image to container registry'
  inputs:
    command: 'buildAndPush'
    # Name of the Docker registry service connection created in Azure DevOps
    containerRegistry: 'bobdocker' 
    repository: 'chevelleman1/bobwebapp'
    dockerfile: 'node-js-dummy-test-master/Dockerfile'
    tags: |
      latest

