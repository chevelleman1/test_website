trigger:
  - main
  - master

resources:
  repositories:
    - repository: automatedtesting # Alias for the second repo
      type: github
      endpoint: 'chevelleman1' # Name of your GitHub service connection
      name: 'chevelleman1/automatedtesting' # The GitHub repo path


pool:
  name: 'linuxBuildBox'

variables:
  workingDir: 'node-js-dummy-test-master'

steps:
- checkout: self # Pulls your app code into /s/node-js-dummy-test-master
  path: app

- checkout: automatedtesting # Pulls your tests into /s/tests
  path: tests

- task: NodeTool@0
  inputs:
    versionSpec: '16.x'
  displayName: '2. Install Node.js'

- script: npm install
  workingDirectory: $(workingDir)
  displayName: '3. Build (Install dependencies)'

- script: |
    echo "Starting local website..."
    # Redirect all output to /dev/null to prevent the STDIO hang
    nohup npm start > /dev/null 2>&1 & 
    
    # Save the PID to a file so the next step can find it
    echo $! > server.pid
    echo "Server started with PID $(cat server.pid)"
    
    # Wait for boot
    sleep 30
  workingDirectory: $(workingDir)
  displayName: '4. Start Server'

- script: |
    npm install
    npm test
    # echo "Testing connection to http://localhost:3000/..."
    # RESPONSE=$(curl -s http://localhost:3000/)
    # echo "Web app response: $RESPONSE"
  workingDirectory: $(Pipeline.Workspace)/tests
  displayName: '5. Run UI Automated Tests'

- script: |
    if [ -f server.pid ]; then
      PID=$(cat server.pid)
      echo "Stopping server with PID $PID..."
      kill $PID || true
      rm server.pid
    fi
  workingDirectory: $(workingDir)
  displayName: '6. Stop Server'
  condition: always() # Ensures the server is stopped even if tests fail


